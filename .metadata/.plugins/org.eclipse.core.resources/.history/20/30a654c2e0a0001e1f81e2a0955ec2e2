package ybsGroup.kuaforRandevuSistemi.business.rules;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;

import org.springframework.stereotype.Service;

import ybsGroup.kuaforRandevuSistemi.core.utilities.helpers.BusinessHoursHelper;
import ybsGroup.kuaforRandevuSistemi.dataAccess.abstracts.AppointmentRepository;
import ybsGroup.kuaforRandevuSistemi.dataAccess.abstracts.HairdresserRepository;
import ybsGroup.kuaforRandevuSistemi.dataAccess.abstracts.ServiceRepository;
import ybsGroup.kuaforRandevuSistemi.entities.concretes.Appointment;
import ybsGroup.kuaforRandevuSistemi.entities.concretes.Hairdresser;


@Service
public class AppointmentBusinessRules {
	private ServiceRepository serviceRepository;
	private HairdresserRepository hairdresserRepository;
	private AppointmentRepository appointmentRepository;
	
	public AppointmentBusinessRules(ServiceRepository serviceRepository, HairdresserRepository hairdresserRepository,
			AppointmentRepository appointmentRepository) {
		this.serviceRepository = serviceRepository;
		this.hairdresserRepository = hairdresserRepository;
		this.appointmentRepository = appointmentRepository;
	}

	public int calculateTotalDuration(List<Integer> servicesId) {
		return servicesId.stream()
				.mapToInt(serviceId -> {
				ybsGroup.kuaforRandevuSistemi.entities.concretes.Service service = this.serviceRepository.findById(serviceId).orElseThrow();
				return service.getDuration();
				}).sum();
	}
	
	public LocalDateTime findAvailableTimeSlot(int hairdresserId , int duration) {
		Hairdresser hairdresser = hairdresserRepository.findById(hairdresserId).orElseThrow();
		List<Appointment> existingAppointments = appointmentRepository.findByHairdresserId(hairdresserId);
		
		LocalDate today = LocalDate.now();
		LocalDateTime possibleStart , possibleEnd;
		LocalDate day;
		
		for (int i = 0; i < 7; i++) {
			
			day = today.plusDays(i);
			
			if (BusinessHoursHelper.working_days.contains(day.getDayOfWeek())) {
				possibleStart = LocalDateTime.of(day, BusinessHoursHelper.start_hour);
				possibleEnd = LocalDateTime.of(day, BusinessHoursHelper.end_hour);
				
				if(possibleStart.plusMinutes(duration).isBefore(possibleEnd)) {
					return possibleStart;
				}else {
					possibleStart=possibleStart.plusMinutes(15);
				}
			}
		}
		return null;
	}
	
	
}
